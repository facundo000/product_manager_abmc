# üìã Planificaci√≥n MVP - Gestor de Productos para Cotill√≥n

## üéØ Objetivo del MVP
Sistema backend completo para gesti√≥n de productos con escaneo de c√≥digos de barras, control de inventario, precios, categor√≠as y auditor√≠a de cambios, con sistema de roles y autenticaci√≥n.

---

## üö® FASE 0: CORRECCIONES CR√çTICAS (Urgente)
**Duraci√≥n estimada:** 1-2 d√≠as

### üî¥ Bug Cr√≠tico de Auditor√≠a
- [ ] **Corregir conversi√≥n de UUID a n√∫mero**
  - Eliminar `parseInt()` en `ProductService` y `AuditInterceptor`
  - Los IDs ya son strings (UUID), no necesitan conversi√≥n
  - Verificar que `record_id` en `audit_log` se guarda correctamente
  - **Archivo afectado:** `src/products/products.service.ts`, `src/common/interceptors/audit.interceptor.ts`

### ‚úÖ Criterios de Aceptaci√≥n:
- Los registros de auditor√≠a muestran UUIDs v√°lidos en `record_id`
- Se puede consultar el historial de un producto correctamente
- No hay valores `NaN` en la tabla `audit_log`

---

## üì¶ FASE 1: COMPLETAR M√ìDULOS B√ÅSICOS
**Duraci√≥n estimada:** 5-7 d√≠as

### 1.1 M√≥dulo de Categories (Prioridad Alta)
**Duraci√≥n:** 2 d√≠as

- [ ] **Implementar CategoriesModule completo**
  - [ ] Crear DTOs (CreateCategoryDto, UpdateCategoryDto)
  - [ ] Implementar CategoriesService con CRUD
  - [ ] Soporte para categor√≠as jer√°rquicas (parent_id)
  - [ ] Implementar CategoriesController
  - [ ] Documentar con Swagger
  - [ ] Proteger rutas con JWT Guard

- [ ] **Activar relaci√≥n Products-Categories**
  - [ ] Descomentar relaci√≥n en entidad Product
  - [ ] Endpoint: Asignar categor√≠as a productos
  - [ ] Endpoint: Filtrar productos por categor√≠a
  - [ ] Incluir categor√≠as en respuesta de productos

**Endpoints a crear:**
```
POST   /categories               (Admin/Employee)
GET    /categories               (P√∫blico)
GET    /categories/:id           (P√∫blico)
GET    /categories/:id/children  (P√∫blico)
PUT    /categories/:id           (Admin/Employee)
DELETE /categories/:id           (Admin)
```

### 1.2 M√≥dulo de Inventory (Prioridad Alta)
**Duraci√≥n:** 2 d√≠as

- [ ] **Implementar InventoryModule**
  - [ ] Crear DTOs (CreateInventoryDto, UpdateInventoryDto)
  - [ ] Implementar InventoryService
  - [ ] Control de stock m√≠nimo/m√°ximo
  - [ ] Alertas de stock bajo
  - [ ] Implementar InventoryController
  - [ ] Documentar con Swagger

- [ ] **Integrar con Products**
  - [ ] Endpoint: Consultar stock de producto
  - [ ] Endpoint: Ajustar inventario (entrada/salida)
  - [ ] Endpoint: Historial de movimientos
  - [ ] Validar stock al eliminar productos

**Endpoints a crear:**
```
POST   /inventory                (Admin/Employee)
GET    /inventory                (Admin/Employee/Viewer)
GET    /inventory/:id            (Admin/Employee/Viewer)
PUT    /inventory/:id            (Admin/Employee)
GET    /inventory/low-stock      (Admin/Employee/Viewer)
POST   /inventory/:id/adjust     (Admin/Employee)
```

### 1.3 M√≥dulo de Pricing (Prioridad Alta)
**Duraci√≥n:** 2 d√≠as

- [ ] **Implementar PricingModule**
  - [ ] Crear DTOs (CreatePricingDto, UpdatePricingDto)
  - [ ] Implementar PricingService
  - [ ] Historial de precios (valid_from, valid_to)
  - [ ] C√°lculo autom√°tico de markup_percentage
  - [ ] Implementar PricingController
  - [ ] Documentar con Swagger

- [ ] **Integrar con Products**
  - [ ] Endpoint: Obtener precio actual de producto
  - [ ] Endpoint: Historial de precios
  - [ ] Endpoint: Actualizar precio (crear nuevo registro)
  - [ ] Validar que siempre haya un precio activo

**Endpoints a crear:**
```
POST   /pricing                  (Admin/Employee)
GET    /pricing/product/:id      (Todos)
GET    /pricing/:id/history      (Admin/Employee)
PUT    /pricing/:id              (Admin/Employee)
```

### 1.4 M√≥dulo de Users (Prioridad Media)
**Duraci√≥n:** 1 d√≠a

- [ ] **Implementar UsersModule (CRUD)**
  - [ ] Crear DTOs (CreateUserDto, UpdateUserDto)
  - [ ] Implementar UsersService (ya existe parcialmente)
  - [ ] Implementar UsersController
  - [ ] Hash de passwords con bcrypt
  - [ ] Documentar con Swagger

**Endpoints a crear:**
```
POST   /users                    (Admin)
GET    /users                    (Admin)
GET    /users/:id                (Admin/Self)
PUT    /users/:id                (Admin/Self)
DELETE /users/:id                (Admin)
PUT    /users/:id/change-password (Self)
```

### ‚úÖ Criterios de Aceptaci√≥n Fase 1:
- Todos los m√≥dulos tienen CRUD completo
- Relaciones entre entidades funcionando
- Documentaci√≥n Swagger completa
- Validaci√≥n de DTOs implementada
- Respuestas HTTP consistentes

---

## üîê FASE 2: SISTEMA DE ROLES Y PERMISOS
**Duraci√≥n estimada:** 2-3 d√≠as

### 2.1 Implementar Guards de Roles
- [ ] **Crear RolesGuard**
  - [ ] Decorador `@Roles()` personalizado
  - [ ] Guard que valida roles del usuario
  - [ ] Aplicar en todos los endpoints seg√∫n permisos

### 2.2 Definir Matriz de Permisos
```
| Endpoint                  | Admin | Employee | Viewer | P√∫blico |
|---------------------------|-------|----------|--------|---------|
| POST /products            |   ‚úì   |    ‚úì     |   ‚úó    |    ‚úó    |
| GET /products             |   ‚úì   |    ‚úì     |   ‚úì    |    ‚úó    |
| GET /products/barcode/:id |   ‚úì   |    ‚úì     |   ‚úì    |    ‚úì    |
| PUT /products/:id         |   ‚úì   |    ‚úì     |   ‚úó    |    ‚úó    |
| DELETE /products/:id      |   ‚úì   |    ‚úó     |   ‚úó    |    ‚úó    |
| POST /categories          |   ‚úì   |    ‚úì     |   ‚úó    |    ‚úó    |
| GET /categories           |   ‚úì   |    ‚úì     |   ‚úì    |    ‚úì    |
| POST /users               |   ‚úì   |    ‚úó     |   ‚úó    |    ‚úó    |
| GET /audit-log            |   ‚úì   |    ‚úó     |   ‚úó    |    ‚úó    |
```

- [ ] **Aplicar Guards en Controllers**
  - [ ] Products
  - [ ] Categories
  - [ ] Inventory
  - [ ] Pricing
  - [ ] Users
  - [ ] Audit Log

### 2.3 Mejorar Sistema de Auditor√≠a
- [ ] **Capturar autom√°ticamente el userId del JWT**
  - [ ] No pasar `created_by`/`updated_by` en DTOs
  - [ ] Obtener del request (decorador `@CurrentUser()`)
  - [ ] Aplicar en todos los m√≥dulos

- [ ] **Extender auditor√≠a a todos los m√≥dulos**
  - [ ] Categories
  - [ ] Inventory
  - [ ] Pricing
  - [ ] Users

### ‚úÖ Criterios de Aceptaci√≥n Fase 2:
- Cada rol tiene permisos espec√≠ficos funcionando
- Intentos de acceso no autorizados retornan 403
- La auditor√≠a captura el usuario del JWT autom√°ticamente
- Todos los m√≥dulos registran cambios en audit_log

---

## üõ†Ô∏è FASE 3: MEJORAS Y SOFT DELETE
**Duraci√≥n estimada:** 2-3 d√≠as

### 3.1 Implementar Soft Delete
- [ ] **Products**
  - [ ] Cambiar de `remove()` a actualizar `status: 'inactive'`
  - [ ] Endpoint de restauraci√≥n
  - [ ] Filtrar productos inactivos por defecto

- [ ] **Extender a otros m√≥dulos**
  - [ ] Categories (con validaci√≥n de productos asociados)
  - [ ] Users (`is_active: false`)

### 3.2 Mejoras en Endpoints
- [ ] **B√∫squeda y Filtrado Avanzado**
  - [ ] Filtrar por m√∫ltiples criterios
  - [ ] B√∫squeda por texto (name, description)
  - [ ] Ordenamiento flexible
  - [ ] Mejorar paginaci√≥n (incluir total de registros)

- [ ] **Endpoints Adicionales**
  - [ ] `GET /products/low-stock` (productos con stock bajo)
  - [ ] `GET /categories/tree` (√°rbol jer√°rquico completo)
  - [ ] `GET /dashboard/stats` (estad√≠sticas generales)

### 3.3 Validaciones de Negocio
- [ ] **Products**
  - [ ] No permitir duplicar barcode/sku
  - [ ] Validar que tenga al menos una categor√≠a
  - [ ] Validar precio antes de activar

- [ ] **Inventory**
  - [ ] No permitir stock negativo
  - [ ] Alertas autom√°ticas de stock bajo

- [ ] **Categories**
  - [ ] No permitir eliminar si tiene productos
  - [ ] Validar jerarqu√≠a (no ciclos)

### ‚úÖ Criterios de Aceptaci√≥n Fase 3:
- Soft delete funcionando en todos los m√≥dulos
- B√∫squeda y filtrado robusto
- Validaciones de negocio implementadas
- Endpoints adicionales operativos

---

## üß™ FASE 4: TESTING
**Duraci√≥n estimada:** 4-5 d√≠as

### 4.1 Tests Unitarios (Prioridad)
- [ ] **ProductsService**
  - [ ] create()
  - [ ] findAll() con filtros
  - [ ] findByBarcode()
  - [ ] update()
  - [ ] remove() (soft delete)

- [ ] **AuditLogService**
  - [ ] createLog()
  - [ ] findByRecord()

- [ ] **CategoriesService, InventoryService, PricingService**

### 4.2 Tests de Integraci√≥n
- [ ] **Products API**
  - [ ] CRUD completo
  - [ ] Endpoint de escaneo
  - [ ] Filtros y paginaci√≥n

- [ ] **Auth & Authorization**
  - [ ] Login/Register
  - [ ] Acceso con diferentes roles
  - [ ] Tokens expirados

### 4.3 Tests E2E (Opcional para MVP)
- [ ] Flujo completo: Crear producto ‚Üí Asignar categor√≠a ‚Üí Ajustar inventario ‚Üí Escanear

### ‚úÖ Criterios de Aceptaci√≥n Fase 4:
- Cobertura de tests > 70% en servicios principales
- Tests de integraci√≥n pasando para endpoints cr√≠ticos
- CI/CD configurado (opcional)

---

## üöÄ FASE 5: PREPARACI√ìN PARA DEPLOYMENT
**Duraci√≥n estimada:** 2-3 d√≠as

### 5.1 Configuraci√≥n para Producci√≥n
- [ ] **Variables de Entorno**
  - [ ] Validar todas las variables necesarias
  - [ ] Configurar para Render (.env.example)
  - [ ] Configurar para Supabase

- [ ] **Base de Datos**
  - [ ] Crear migraciones TypeORM
  - [ ] Script de seed para datos iniciales
  - [ ] Configurar conexi√≥n a Supabase

### 5.2 Seguridad
- [ ] **Validaciones**
  - [ ] Helmet.js configurado
  - [ ] Rate limiting
  - [ ] CORS configurado correctamente

- [ ] **Logs y Monitoreo**
  - [ ] Logger configurado (Winston o similar)
  - [ ] Manejo de errores global
  - [ ] Health check endpoint

### 5.3 Documentaci√≥n
- [ ] **README.md actualizado**
  - [ ] Instrucciones de instalaci√≥n
  - [ ] Variables de entorno
  - [ ] Endpoints disponibles
  - [ ] Gu√≠a de deployment

- [ ] **Swagger completo**
  - [ ] Todos los endpoints documentados
  - [ ] Ejemplos de requests/responses
  - [ ] Descripci√≥n de errores

### 5.4 Deployment
- [ ] **Render**
  - [ ] Configurar servicio
  - [ ] Variables de entorno
  - [ ] Build y deploy

- [ ] **Supabase**
  - [ ] Configurar proyecto
  - [ ] Ejecutar migraciones
  - [ ] Seed de datos iniciales

### ‚úÖ Criterios de Aceptaci√≥n Fase 5:
- API desplegada y accesible p√∫blicamente
- Base de datos en Supabase funcionando
- Swagger accesible en /api/docs
- README completo con instrucciones

---

## üìä RESUMEN DE TIEMPOS

| Fase | Duraci√≥n | Prioridad |
|------|----------|-----------|
| Fase 0: Correcciones Cr√≠ticas | 1-2 d√≠as | üî¥ Cr√≠tica |
| Fase 1: M√≥dulos B√°sicos | 5-7 d√≠as | üü† Alta |
| Fase 2: Roles y Permisos | 2-3 d√≠as | üü† Alta |
| Fase 3: Mejoras y Soft Delete | 2-3 d√≠as | üü° Media |
| Fase 4: Testing | 4-5 d√≠as | üü° Media |
| Fase 5: Deployment | 2-3 d√≠as | üü¢ Baja |
| **TOTAL** | **16-23 d√≠as** | |

**Nota:** Los tiempos son estimaciones para trabajo dedicado. Pueden variar seg√∫n experiencia y tiempo disponible.

---

## üéØ HITOS CLAVE

### Hito 1: MVP B√°sico (Fase 0 + 1)
- ‚úÖ Bug de auditor√≠a corregido
- ‚úÖ Todos los m√≥dulos implementados
- ‚úÖ CRUD completo de productos, categor√≠as, inventario, precios
- **Tiempo estimado:** 6-9 d√≠as

### Hito 2: MVP Seguro (+ Fase 2)
- ‚úÖ Sistema de roles funcionando
- ‚úÖ Auditor√≠a completa en todos los m√≥dulos
- **Tiempo estimado:** 8-12 d√≠as

### Hito 3: MVP Robusto (+ Fase 3)
- ‚úÖ Soft delete implementado
- ‚úÖ Validaciones de negocio
- ‚úÖ B√∫squeda avanzada
- **Tiempo estimado:** 10-15 d√≠as

### Hito 4: MVP Testeado (+ Fase 4)
- ‚úÖ Tests unitarios y de integraci√≥n
- ‚úÖ Cobertura aceptable
- **Tiempo estimado:** 14-20 d√≠as

### Hito 5: MVP en Producci√≥n (+ Fase 5)
- ‚úÖ Desplegado en Render + Supabase
- ‚úÖ Documentaci√≥n completa
- **Tiempo estimado:** 16-23 d√≠as

---

## üîÑ METODOLOG√çA SUGERIDA

### Desarrollo Iterativo
1. **Completar una funcionalidad a la vez**
2. **Probar manualmente en Swagger**
3. **Hacer commit con mensaje descriptivo**
4. **Pasar a la siguiente tarea**

### Priorizaci√≥n
- ‚úÖ Primero: Corregir bugs cr√≠ticos
- ‚úÖ Segundo: Completar m√≥dulos b√°sicos (Categories, Inventory, Pricing)
- ‚úÖ Tercero: Implementar sistema de roles
- ‚úÖ Cuarto: Mejoras y validaciones
- ‚úÖ Quinto: Testing
- ‚úÖ Sexto: Deployment

---

## üìå PR√ìXIMOS PASOS INMEDIATOS

### Esta Semana:
1. ‚ö†Ô∏è **URGENTE:** Corregir bug de UUID en auditor√≠a
2. üéØ Implementar CategoriesModule completo
3. üéØ Implementar InventoryModule completo

### Pr√≥xima Semana:
1. üéØ Implementar PricingModule completo
2. üéØ Completar UsersModule (CRUD)
3. üîê Implementar sistema de roles y permisos

---

## üí° RECOMENDACIONES

1. **No saltar la Fase 0** - El bug de auditor√≠a puede causar problemas mayores
2. **Probar cada m√≥dulo antes de continuar** - Usar Swagger para validar
3. **Hacer commits frecuentes** - Facilita revertir cambios si algo falla
4. **Documentar mientras desarrollas** - Es m√°s dif√≠cil hacerlo despu√©s
5. **Priorizar funcionalidad sobre perfecci√≥n** - Es un MVP, iterar despu√©s
6. **Configurar las migraciones desde el inicio** - Evita problemas en deployment

---

## üìû SOPORTE

Si necesitas ayuda espec√≠fica en alguna fase o tarea:
1. Comparte el c√≥digo del m√≥dulo/archivo espec√≠fico
2. Describe el problema o duda
3. Indicar en qu√© fase est√°s trabajando

¬°√âxito con el desarrollo! üöÄ